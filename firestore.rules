rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ------------------------
    // Helper functions
    // ------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }

    function tripDoc(tripId) {
      return /databases/$(database)/documents/trips/$(tripId);
    }

    function tripExists(tripId) {
      return exists(tripDoc(tripId));
    }

    function isTripOwner(tripId) {
      return isSignedIn()
        && tripExists(tripId)
        && get(tripDoc(tripId)).data.userId == request.auth.uid;
    }

    function isTripActive(tripId) {
      return tripExists(tripId)
        && get(tripDoc(tripId)).data.tripType == 'active';
    }

    function isAdmin() {
      return isSignedIn()
        && exists(userDoc())
        && get(userDoc()).data.role == 'admin';
    }

    // ------------------------
    // Checkpoints
    // ------------------------
    match /checkpoints/{checkpointId} {
      allow read: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());

      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.latitude is number
        && request.resource.data.longitude is number
        && request.resource.data.timestamp is timestamp
        && request.resource.data.createdAt is timestamp;

      allow update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ------------------------
    // Location Comments
    // ------------------------
    match /location_comments/{commentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn()
        && (request.resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ------------------------
    // Latest Trip Locations (realtime tracking)
    // One doc per trip: id == tripId
    // ------------------------
    match /latest_trip_locations/{tripId} {
      // Owner, driver (same uid as write), or admin can read
      allow read: if isSignedIn()
        && (isTripOwner(tripId) || isAdmin() || resource.data.driverId == request.auth.uid);

      // Driver writes to his own trip's doc only
      allow write: if isSignedIn()
        && request.resource.data.driverId == request.auth.uid
        && request.resource.data.tripId == tripId
        && isTripOwner(tripId);
    }

    // ------------------------
    // Trip Locations (Checkpoints)
    // ------------------------
    match /trip_locations/{locationId} {
      // Owner, driver, or admin may read
      allow read: if isSignedIn()
        && (isTripOwner(resource.data.tripId) || isAdmin() || resource.data.driverId == request.auth.uid);

      // Allow owner to create checkpoints (even for past trips to support manual import)
      allow create: if isSignedIn()
        && isTripOwner(request.resource.data.tripId)
        && request.resource.data.driverId == request.auth.uid
        && request.resource.data.latitude is number
        && request.resource.data.longitude is number
        && request.resource.data.recordedAt is timestamp
        && request.resource.data.tripId is string;

      allow update, delete: if false;
    }

    // ------------------------
    // Trips
    // ------------------------
    match /trips/{tripId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ------------------------
    // Users
    // ------------------------
    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
      match /trips/{tripId} {
        allow read: if isSignedIn() && request.auth.uid == userId;
        allow create: if isSignedIn()
          && request.auth.uid == userId
          && request.resource.data.userId == userId;
        allow update, delete: if isSignedIn() && request.auth.uid == userId;
        match /checkpoints/{checkpointId} {
          allow read: if isSignedIn() && request.auth.uid == userId;
          allow create: if isSignedIn()
            && request.auth.uid == userId
            && request.resource.data.lat is number
            && request.resource.data.lat >= -90 && request.resource.data.lat <= 90
            && request.resource.data.lng is number
            && request.resource.data.lng >= -180 && request.resource.data.lng <= 180
            && request.resource.data.recordedAt is timestamp;
          allow update, delete: if false;
        }
        match /comments/{commentId} {
          allow read: if isSignedIn() && request.auth.uid == userId;
          allow write: if isSignedIn() && request.auth.uid == userId;
        }
      }
      match /latest_location/{docId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
    }
    // Analytics-friendly time-series and history collections
    match /trip_location_history/{tripId}/positions/{posId} {
      allow read: if isSignedIn() && (isTripOwner(tripId) || isAdmin());
      allow create: if isSignedIn()
        && isTripOwner(tripId)
        && request.resource.data.driverId == request.auth.uid
        && request.resource.data.lat is number
        && request.resource.data.lat >= -90 && request.resource.data.lat <= 90
        && request.resource.data.lng is number
        && request.resource.data.lng >= -180 && request.resource.data.lng <= 180
        && request.resource.data.recordedAt is timestamp;
      allow update, delete: if false;
    }
    match /comments/{commentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.tripId is string
        && request.resource.data.timestamp is timestamp;
      allow update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }
    match /ts_trips/{date}/users/{userId}/events/{eventId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow write: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.userId == userId
        && request.resource.data.time is timestamp
        && (request.resource.data.type == 'start' || request.resource.data.type == 'end');
    }
    match /ts_checkpoints/{date}/users/{userId}/events/{eventId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow write: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.userId == userId
        && request.resource.data.lat is number
        && request.resource.data.lat >= -90 && request.resource.data.lat <= 90
        && request.resource.data.lng is number
        && request.resource.data.lng >= -180 && request.resource.data.lng <= 180
        && request.resource.data.recordedAt is timestamp;
    }
    match /ts_locations/{date}/users/{userId}/trips/{tripId}/positions/{posId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow write: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.userId == userId
        && request.resource.data.lat is number
        && request.resource.data.lat >= -90 && request.resource.data.lat <= 90
        && request.resource.data.lng is number
        && request.resource.data.lng >= -180 && request.resource.data.lng <= 180
        && request.resource.data.recordedAt is timestamp;
    }
    match /od_daily/{date}/users/{userId}/trips/{tripId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow write: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.userId == userId
        && request.resource.data.origin is string
        && request.resource.data.destination is string
        && request.resource.data.mode is string
        && request.resource.data.startTime is timestamp
        && request.resource.data.endTime is timestamp;
    }
    match /od_flat/{docId} {
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.dateKey is string
        && request.resource.data.origin is string
        && request.resource.data.destination is string
        && request.resource.data.mode is string
        && request.resource.data.startTime is timestamp
        && request.resource.data.endTime is timestamp;
    }
    match /searchLogs/{docId} {
      allow read: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
    }
    match /navigationLogs/{docId} {
      allow read: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
    }
    match /notificationLogs/{docId} {
      allow read: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
    }
    match /appPerformance/{docId} {
      allow read: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
    }
    match /auto_trips/{tripId} {
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }
  }
}
