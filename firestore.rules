rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ------------------------
    // Helper functions
    // ------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }

    function tripDoc(tripId) {
      return /databases/$(database)/documents/trips/$(tripId);
    }

    function tripExists(tripId) {
      return exists(tripDoc(tripId));
    }

    function isTripOwner(tripId) {
      return isSignedIn()
        && tripExists(tripId)
        && get(tripDoc(tripId)).data.userId == request.auth.uid;
    }

    function isTripActive(tripId) {
      return tripExists(tripId)
        && get(tripDoc(tripId)).data.tripType == 'active';
    }

    function isAdmin() {
      return isSignedIn()
        && exists(userDoc())
        && get(userDoc()).data.role == 'admin';
    }

    // ------------------------
    // Checkpoints
    // ------------------------
    match /checkpoints/{checkpointId} {
      allow read: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());

      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.latitude is number
        && request.resource.data.longitude is number
        && request.resource.data.timestamp is timestamp
        && request.resource.data.createdAt is timestamp;

      allow update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ------------------------
    // Location Comments
    // ------------------------
    match /location_comments/{commentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn()
        && (request.resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ------------------------
    // Latest Trip Locations (realtime tracking)
    // One doc per trip: id == tripId
    // ------------------------
    match /latest_trip_locations/{tripId} {
      // Owner, driver (same uid as write), or admin can read
      allow read: if isSignedIn()
        && (isTripOwner(tripId) || isAdmin() || resource.data.driverId == request.auth.uid);

      // Driver writes to his own trip's doc only
      allow write: if isSignedIn()
        && request.resource.data.driverId == request.auth.uid
        && request.resource.data.tripId == tripId
        && isTripOwner(tripId);
    }

    // ------------------------
    // Trip Locations (Checkpoints)
    // ------------------------
    match /trip_locations/{locationId} {
      // Owner, driver, or admin may read
      allow read: if isSignedIn()
        && (isTripOwner(resource.data.tripId) || isAdmin() || resource.data.driverId == request.auth.uid);

      // Allow owner to create checkpoints (even for past trips to support manual import)
      allow create: if isSignedIn()
        && isTripOwner(request.resource.data.tripId)
        && request.resource.data.driverId == request.auth.uid
        && request.resource.data.latitude is number
        && request.resource.data.longitude is number
        && request.resource.data.recordedAt is timestamp
        && request.resource.data.tripId is string;

      allow update, delete: if false;
    }

    // ------------------------
    // Trips
    // ------------------------
    match /trips/{tripId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ------------------------
    // Users
    // ------------------------
    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }
  }
}
